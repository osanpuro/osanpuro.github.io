<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>高機能メモ帳 - おさんツール</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* =========================================
           共通スタイル
        ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background-color: #f0f2f5; padding-top: 80px; color: #202124; }
        .hidden { display: none !important; }

        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 64px;
            background: #202124; color: white; display: flex; justify-content: space-between; align-items: center;
            padding: 0 24px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .logo a { font-size: 22px; font-weight: bold; color: #ffffff; text-decoration: none; }

        /* ログイン状態バッジ */
        .storage-status {
            display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px;
        }
        .status-local { background: #e8f0fe; color: #1a73e8; }
        .status-cloud { background: #e6f4ea; color: #1e8e3e; }

        /* メモ帳デザイン */
        main { 
            max-width: 1000px; margin: 0 auto; padding: 20px; 
            display: grid; grid-template-columns: 1fr 320px; gap: 24px; 
        }
        
        .editor-section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #memoTitle { 
            width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 18px; outline: none; margin-bottom: 15px; 
            appearance: none; -webkit-appearance: none; font-weight: bold;
        }
        #memoBody { 
            width: 100%; height: 450px; padding: 15px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; resize: none; outline: none; line-height: 1.6; 
            appearance: none; -webkit-appearance: none;
        }

        .button-area { display: flex; gap: 10px; margin-top: 20px; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .btn-save { background: #1a73e8; color: white; justify-content: center; min-width: 120px; }
        .btn-save:hover { background: #1558b0; }
        .btn-delete { background: #fce8e6; color: #d93025; }
        .btn-delete:hover { background: #faddd9; }

        /* 自動保存ステータス表示 */
        #auto-save-text { font-size: 12px; color: #888; margin-left: 10px; transition: color 0.3s; }
        .status-saving { color: #ea4335 !important; font-weight: bold; } /* 保存中は赤っぽく */

        /* リストセクション */
        .list-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 600px; display: flex; flex-direction: column; }
        .list-section h3 { font-size: 16px; margin-bottom: 15px; color: #3c4043; display: flex; align-items: center; gap: 8px; }
        
        #listArea { flex-grow: 1; overflow-y: auto; }
        .memo-item {
            padding: 12px; border-radius: 8px; cursor: pointer; border-bottom: 1px solid #f1f3f4;
            transition: 0.2s; font-size: 14px; display: flex; justify-content: space-between; align-items: center;
        }
        .memo-item:hover { background-color: #f8f9fa; }
        .memo-item .title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; font-weight: bold; color: #444; }
        .memo-item.active { background-color: #e8f0fe; color: #1a73e8; }

        /* 共通UI */
        .user-menu-container { position: relative; }
        .icon-button { background: none; border: none; cursor: pointer; color: white; display: flex; align-items: center; }
        .dropdown-menu { position: absolute; top: 56px; right: 0; width: 220px; background: white; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border: 1px solid #ddd; z-index: 1100; overflow: hidden; }
        .dropdown-menu button { width: 100%; padding: 12px 20px; border: none; background: none; text-align: left; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .mini-window { width: 360px; max-width: 90%; background: white; border-radius: 12px; padding: 25px; text-align: center; }

        /* トースト通知 (保存完了など) */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px;
            position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        /* --- スマホ対応 --- */
        @media (max-width: 800px) {
            body { padding-top: 60px; padding-bottom: 20px; }
            header { padding: 0 16px; height: 56px; }
            .logo a { font-size: 18px; }
            main { display: flex; flex-direction: column; padding: 15px; gap: 20px; }
            .editor-section { padding: 15px; }
            #memoBody { height: 300px; }
            .list-section { height: 400px; }
            .memo-item .title-text { max-width: 70%; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><a href="../index.html">おさんツール</a></div>
        <div class="user-menu-container">
            <div id="header-guest-nav">
                <button class="nav-text-btn" style="color:white; background:none; border:1px solid white; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;" id="nav-signin">サインイン</button>
            </div>
            <button id="main-user-btn" class="icon-button hidden"><span class="material-icons" style="font-size:32px;">account_circle</span></button>
            <div id="dropdown-ui" class="dropdown-menu hidden">
                <div style="padding: 12px 20px; font-size: 12px; color: #5f6368; border-bottom: 1px solid #eee; background: #fafafa;" id="display-email"></div>
                <button id="trigger-logout">ログアウト</button>
            </div>
        </div>
    </header>

    <main>
        <div class="editor-section">
            <div id="status-badge" class="storage-status status-local">
                <span class="material-icons" style="font-size:16px;">devices</span>
                <span id="status-text">ローカル保存モード</span>
            </div>

            <input type="text" style="position:fixed; top:-100px; left:-100px; width:1px; height:1px; opacity:0;" aria-hidden="true">

            <input type="text" id="memoTitle" autocomplete="off" placeholder="無題のメモ">
            <textarea id="memoBody" placeholder="ここに内容を入力してください..."></textarea>
            
            <div class="button-area">
                <button id="saveBtn" class="btn btn-save"><span class="material-icons">save</span>保存</button>
                <span id="auto-save-text"></span> <div style="flex-grow:1;"></div>
                <button id="deleteBtn" class="btn btn-delete"><span class="material-icons">delete</span></button>
            </div>
        </div>

        <div class="list-section">
            <h3><span class="material-icons">list</span> 保存済みメモ</h3>
            <div id="listArea"></div>
        </div>
    </main>

    <div id="toast">保存しました</div>

    <div id="modal-ui" class="modal-overlay hidden">
        <div class="mini-window">
            <h3 id="modal-title" style="margin-bottom:20px;">サインイン</h3>
            <input type="email" id="input-email" autocomplete="username" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;" placeholder="メールアドレス">
            <input type="password" id="input-pass" autocomplete="current-password" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;" placeholder="パスワード">
            <button id="auth-execute-btn" style="width:100%; padding:10px; background:#1a73e8; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">送信</button>
            <p id="auth-toggle-text" style="color:#1a73e8; font-size:13px; cursor:pointer; margin-top:15px;">新規登録はこちら</p>
            <button onclick="document.getElementById('modal-ui').classList.add('hidden')" style="margin-top:15px; background:none; border:none; color:#999; cursor:pointer;">キャンセル</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtQGq5IJXyoHGBGpx25ZfVkXWL-iRRqC8",
            authDomain: "my-programming-tools-auth.firebaseapp.com",
            projectId: "my-programming-tools-auth",
            appId: "1:617449767952:web:12f75dcb19f2035d637695"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribe = null;
        let autoSaveTimer = null; // 自動保存用のタイマー変数
        const LS_PREFIX = "osan-memo-";

        const titleInput = document.getElementById('memoTitle');
        const bodyInput = document.getElementById('memoBody');
        const listArea = document.getElementById('listArea');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        const autoSaveText = document.getElementById('auto-save-text');

        // --- トースト表示機能 ---
        function showToast(message) {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- 保存・削除のコアロジック ---

        // isAuto: 手動保存ならfalse, 自動保存ならtrue
        async function saveMemo(isAuto = false) {
            const title = titleInput.value.trim() || "無題のメモ";
            const body = bodyInput.value;

            // 自動保存時に中身が空っぽなら何もしない
            if (isAuto && body.trim() === "") return;

            autoSaveText.textContent = "保存中...";
            autoSaveText.classList.add('status-saving');

            try {
                if (currentUser) {
                    // クラウド保存
                    await setDoc(doc(db, "users", currentUser.uid, "memos", title), {
                        title, body, updatedAt: Date.now()
                    });
                } else {
                    // ローカル保存
                    localStorage.setItem(LS_PREFIX + title, body);
                    refreshLocalList();
                }

                // 保存完了後の処理
                autoSaveText.textContent = "保存完了";
                autoSaveText.classList.remove('status-saving');
                
                // 手動保存のときだけ、目立つ通知を出す（自動保存は静かに）
                if (!isAuto) {
                    showToast("保存しました");
                } else {
                    // 2秒後に「保存完了」の文字を消す
                    setTimeout(() => {
                        if(autoSaveText.textContent === "保存完了") autoSaveText.textContent = "";
                    }, 2000);
                }

            } catch(e) {
                console.error(e);
                if (!isAuto) alert("保存に失敗しました");
                autoSaveText.textContent = "保存失敗";
            }
        }

        // 自動保存トリガー (入力があったらタイマーをセット)
        function triggerAutoSave() {
            // すでに待機中なら一旦キャンセル
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            
            // UIを「編集中...」にする
            autoSaveText.textContent = "編集中...";
            autoSaveText.classList.remove('status-saving');

            // 3秒(3000ms)後に保存を実行
            autoSaveTimer = setTimeout(() => {
                saveMemo(true); // true = 自動保存モード
            }, 3000);
        }

        // 入力欄のイベントリスナー
        titleInput.addEventListener('input', triggerAutoSave);
        bodyInput.addEventListener('input', triggerAutoSave);


        async function deleteMemo() {
            const title = titleInput.value.trim();
            if (!title) return;
            if (!confirm("「" + title + "」を削除しますか？")) return;

            if (currentUser) {
                await deleteDoc(doc(db, "users", currentUser.uid, "memos", title));
            } else {
                localStorage.removeItem(LS_PREFIX + title);
                refreshLocalList();
            }
            showToast("削除しました");
            titleInput.value = "";
            bodyInput.value = "";
            autoSaveText.textContent = "";
        }

        // --- リスト表示 ---

        function refreshLocalList() {
            listArea.innerHTML = "";
            let items = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(LS_PREFIX)) {
                    items.push({
                        key: key,
                        title: key.replace(LS_PREFIX, ""),
                        body: localStorage.getItem(key)
                    });
                }
            }
            items.forEach(item => createListItem(item.title, item.body));
        }

        function createListItem(title, body) {
            const item = document.createElement('div');
            item.className = 'memo-item';
            
            // 現在開いているメモと同じタイトルなら色を変えるなどの判定用（簡易実装）
            if (title === titleInput.value) item.classList.add('active');

            item.innerHTML = `<span class="title-text">${title}</span><span class="material-icons" style="font-size:16px; color:#ccc;">chevron_right</span>`;
            item.onclick = () => {
                titleInput.value = title;
                bodyInput.value = body;
                autoSaveText.textContent = ""; // 読み込み直後は保存ステータスをリセット
                
                // スマホ時は上へスクロール
                if (window.innerWidth <= 800) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                
                // リストの選択状態更新（簡易）
                document.querySelectorAll('.memo-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
            };
            listArea.appendChild(item);
        }

        // --- 状態監視 ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (unsubscribe) unsubscribe();

            if (user) {
                statusBadge.className = "storage-status status-cloud";
                statusText.textContent = "クラウド保存モード";
                document.getElementById('main-user-btn').classList.remove('hidden');
                document.getElementById('header-guest-nav').classList.add('hidden');
                document.getElementById('display-email').textContent = user.email;

                const q = query(collection(db, "users", user.uid, "memos"), orderBy("updatedAt", "desc"));
                unsubscribe = onSnapshot(q, (snapshot) => {
                    listArea.innerHTML = "";
                    snapshot.forEach(doc => createListItem(doc.data().title, doc.data().body));
                });
            } else {
                statusBadge.className = "storage-status status-local";
                statusText.textContent = "ローカル保存";
                document.getElementById('main-user-btn').classList.add('hidden');
                document.getElementById('header-guest-nav').classList.remove('hidden');
                refreshLocalList();
            }
        });

        // ボタンイベント
        document.getElementById('saveBtn').onclick = () => saveMemo(false); // 手動保存
        document.getElementById('deleteBtn').onclick = deleteMemo;
        
        document.getElementById('nav-signin').onclick = () => document.getElementById('modal-ui').classList.remove('hidden');
        document.getElementById('trigger-logout').onclick = () => signOut(auth);
        document.getElementById('main-user-btn').onclick = (e) => { e.stopPropagation(); document.getElementById('dropdown-ui').classList.toggle('hidden'); };
        document.body.onclick = () => document.getElementById('dropdown-ui').classList.add('hidden');
        
        document.getElementById('auth-execute-btn').onclick = async () => {
            const e = document.getElementById('input-email').value;
            const p = document.getElementById('input-pass').value;
            const mode = document.getElementById('modal-title').textContent;
            try {
                if(mode === 'サインイン') await signInWithEmailAndPassword(auth, e, p);
                else await createUserWithEmailAndPassword(auth, e, p);
                document.getElementById('modal-ui').classList.add('hidden');
            } catch (err) { alert(err.message); }
        };
        document.getElementById('auth-toggle-text').onclick = () => {
            const t = document.getElementById('modal-title');
            t.textContent = t.textContent === 'サインイン' ? 'アカウント作成' : 'サインイン';
        };
    </script>
</body>
</html>