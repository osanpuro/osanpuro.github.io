<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãƒ„ãƒ¼ãƒ« - ãŠã•ã‚“ãƒ„ãƒ¼ãƒ«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* =========================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
        ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background-color: #f0f2f5; padding-top: 80px; padding-bottom: 40px; color: #202124; }
        .hidden { display: none !important; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 64px;
            background: #202124; color: white;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header-left { display: flex; align-items: center; gap: 10px; }
        .logo a { font-size: 20px; font-weight: bold; color: #ffffff; text-decoration: none; }

        #hamburger-btn {
            background: none; border: none; color: white; cursor: pointer;
            display: none; align-items: center; justify-content: center;
            padding: 5px; margin-right: 5px;
        }
        #hamburger-btn .material-icons { font-size: 28px; }

        #header-guest-nav { display: flex; align-items: center; }
        .nav-text-btn {
            background: none; border: 1px solid white; color: white;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            margin-left: 8px; font-size: 13px; transition: 0.2s; white-space: nowrap;
        }
        .nav-text-btn.primary { background: white; color: #202124; font-weight: bold; }
        .icon-button { background: none; border: none; cursor: pointer; color: white; display: flex; align-items: center; }
        .icon-button .material-icons { font-size: 32px; }

        .user-menu-container { position: relative; }
        .dropdown-menu {
            position: absolute; top: 50px; right: 0; width: 220px; background: white; border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); border: 1px solid #ddd; z-index: 1100; overflow: hidden;
        }
        .dropdown-menu button {
            width: 100%; padding: 12px 20px; border: none; background: none;
            text-align: left; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f1f1f1;
        }
        .user-email-info { padding: 12px 20px; font-size: 12px; color: #5f6368; border-bottom: 1px solid #eee; background: #fafafa; word-break: break-all; }
        .btn-delete { color: #ea4335 !important; }

        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        #drawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #drawer-overlay.open { opacity: 1; pointer-events: auto; }

        #mobile-drawer {
            position: fixed; top: 0; left: 0; width: 260px; height: 100%;
            background: white; z-index: 1200; transform: translateX(-100%); transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        #mobile-drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee;
            font-weight: bold; color: #202124; display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-list { list-style: none; padding: 10px 0; }
        .drawer-list li a {
            display: block; padding: 15px 20px; color: #3c4043; text-decoration: none;
            font-size: 15px; border-left: 4px solid transparent; transition: 0.2s;
        }
        .drawer-list li a:hover { background: #f0f2f5; }
        .drawer-list li a.active { background: #e8f0fe; color: #1a73e8; border-left-color: #1a73e8; font-weight: bold; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        main { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        h1 { font-size: 24px; margin-bottom: 20px; color: #3c4043; }

        .tool-container { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .section-box { flex: 1; min-width: 300px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        
        .section-header {
            background: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;
        }
        .section-header h2 { font-size: 15px; color: #5f6368; display: flex; align-items: center; gap: 8px; margin: 0; }
        .section-content { padding: 20px; }

        textarea { 
            width: 100%; height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; 
            font-size: 15px; resize: vertical; line-height: 1.6; font-family: monospace; background: white;
        }
        textarea:focus { border-color: #1a73e8; outline: none; background: #fdfdfd; }
        
        .input-hint {
            font-size: 12px; color: #666; background: #e8f0fe; padding: 10px; border-radius: 4px; margin-bottom: 10px; line-height: 1.5;
        }

        .control-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: #3c4043; }
        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; 
            appearance: none; -webkit-appearance: none;
        }

        /* ä¿å­˜ãƒœã‚¿ãƒ³é¡ */
        .cloud-actions { display: flex; flex-direction: column; gap: 8px; }
        .cloud-btn-row { display: flex; gap: 8px; }
        .c-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; }
        .bg-blue { background: #1a73e8; }
        .bg-green { background: #34a853; }
        .bg-red { background: #ea4335; }
        #list-save-status { font-size: 11px; margin-left: 5px; color: #888; font-weight: normal; }
        .status-saving { color: #ea4335 !important; font-weight: bold; }

        /* å®Ÿè¡Œã‚¨ãƒªã‚¢ */
        .execution-area { margin-top: 20px; text-align: center; background: white; padding: 30px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .action-btn { 
            background: #34a853; color: white; padding: 15px 0; border: none; border-radius: 8px; 
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; max-width: 300px; 
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        .action-btn:hover { background: #2d9147; transform: translateY(-2px); }
        
        #btn-csv-download { margin-top: 15px; background: #5f6368; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; width: 100%; max-width: 300px; font-weight: bold; }
        #btn-csv-download:disabled { background: #dadce0; cursor: not-allowed; opacity: 0.7; }

        /* çµæœå‡ºåŠ› */
        #output-header { 
            display: none; justify-content: space-between; align-items: center; 
            margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #ddd; 
        }
        #output-title { font-weight: bold; font-size: 18px; color: #3c4043; display: flex; align-items: center; gap: 5px; }

        #output { margin-top: 0; }
        
        /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes highlightFade {
            0% { background-color: #fef08a; transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        .updated-flash { animation: highlightFade 0.6s ease-out; }

        .group-box { 
            margin-bottom: 15px; padding: 15px; border-left: 5px solid #34a853; 
            background: white; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.6;
        }
        .group-title { font-weight: bold; color: #202124; display: block; margin-bottom: 5px; }

        /* å±¥æ­´ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #history-save-indicator {
            margin-top: 10px; font-size: 13px; color: #555; font-weight: bold; min-height: 20px;
        }
        .text-wait { color: #fbbc04; }
        .text-saving { color: #ea4335; }
        .text-done { color: #34a853; }
        .text-error { color: #d93025; background: #fce8e6; padding: 5px 10px; border-radius: 4px; display: inline-block; }

        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        #history-list { list-style: none; margin-top: 0; }
        .history-item { 
            padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; 
        }
        .history-item:last-child { border-bottom: none; }
        .history-left { flex: 1; min-width: 0; padding-right: 10px; }
        
        .history-date { font-size: 11px; color: #888; margin-bottom: 2px; }
        .history-info { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 2px; }
        .history-preview { font-size: 12px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .history-actions { display: flex; gap: 5px; align-items: center; }
        .history-actions button {
            padding: 8px 12px; border-radius: 4px; border: 1px solid #1a73e8; 
            background: white; color: #1a73e8; cursor: pointer; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .history-actions button:hover { background: #e8f0fe; }
        
        .btn-history-delete { color: #ea4335 !important; border-color: #ea4335 !important; }
        .btn-history-delete:hover { background: #fce8e6 !important; }
        .btn-history-delete .material-icons { font-size: 16px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .mini-window { width: 360px; max-width: 90%; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .window-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .window-body { padding: 25px; text-align: center; }
        .google-btn { width: 100%; padding: 10px; background: white; border: 1px solid #dadce0; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; font-weight: bold; }
        .google-btn img { width: 18px; margin-right: 10px; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .primary-btn { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        #storage-status {
            font-size: 11px; margin-left: 5px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555;
        }
        .status-cloud { background: #e8f0fe !important; color: #1a73e8 !important; }
        .status-local { background: #fce8e6 !important; color: #c5221f !important; }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px;
            position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media (max-width: 768px) {
            #hamburger-btn { display: flex; }
            main { padding: 0 15px; }
            .tool-container { flex-direction: column; }
            .section-box { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button id="hamburger-btn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
                <span class="material-icons">menu</span>
            </button>
            <div class="logo"><a href="../index.html">ãŠã•ã‚“ãƒ„ãƒ¼ãƒ«</a></div>
        </div>

        <div class="user-menu-container">
            <div id="header-guest-nav">
                <button class="nav-text-btn" id="nav-signin">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
                <button class="nav-text-btn primary" id="nav-signup">ç™»éŒ²</button>
            </div>
            <button id="main-user-btn" class="icon-button hidden">
                <span class="material-icons">account_circle</span>
            </button>
            <div id="dropdown-ui" class="dropdown-menu hidden">
                <div class="user-email-info" id="display-email"></div>
                <button id="trigger-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                <button id="trigger-delete-account" class="btn-delete">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button>
            </div>
        </div>
    </header>

    <div id="drawer-overlay"></div>
    <nav id="mobile-drawer">
        <div class="drawer-header">
            <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
            <span class="material-icons" id="drawer-close" style="cursor:pointer;">close</span>
        </div>
        <ul class="drawer-list">
            <li><a href="../index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a></li>
            <li><a href="#" class="active">ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</a></li>
        </ul>
    </nav>

    <main>
        <h1>ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</h1>
        
        <div class="tool-container">
            <div class="section-box">
                <div class="section-header" onclick="toggleSection('names-content', 'names-icon')">
                    <h2>åç°¿ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                    <span class="material-icons" id="names-icon">expand_less</span>
                </div>
                <div class="section-content" id="names-content">
                    <div class="input-hint">
                        <span style="font-weight:bold;">ğŸ’¡ ãƒãƒ©ãƒ³ã‚¹ã‚ˆãåˆ†ã‘ã‚‹æ–¹æ³•ï¼š</span><br>
                        å±æ€§ï¼ˆç”·å¥³ã‚„å½¹è·ãªã©ï¼‰ã”ã¨ã«<span style="color:#ea4335; font-weight:bold;">1è¡Œã‚ã‘ã¦</span>å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
                        ç©ºç™½è¡Œã§åŒºåˆ‡ã‚‰ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã«ã€å‡ç­‰ã«é…åˆ†ã•ã‚Œã¾ã™ã€‚
                    </div>
                    
                    <textarea id="names-input" placeholder="ï¼ˆä¾‹ï¼šç”·å­ã®å…¥åŠ›ï¼‰
ä½è—¤
éˆ´æœ¨
é«˜æ©‹

ï¼ˆâ†ã“ã“ã«ç©ºç™½è¡Œã‚’å…¥ã‚Œã‚‹ã¨åŒºåˆ‡ã‚‰ã‚Œã¾ã™ï¼‰

ï¼ˆä¾‹ï¼šå¥³å­ã®å…¥åŠ›ï¼‰
ç”°ä¸­
æ¸¡è¾º
ä¼Šè—¤"></textarea>
                </div>
            </div>

            <div class="section-box">
                <div class="section-header" onclick="toggleSection('config-content', 'config-icon')">
                    <h2>è¨­å®šãƒ»ä¿å­˜</h2>
                    <span class="material-icons" id="config-icon">expand_less</span>
                </div>
                <div class="section-content" id="config-content">
                    <div class="control-group">
                        <label>ã‚°ãƒ«ãƒ¼ãƒ—æ•°</label>
                        <input type="number" id="group-count" min="1" value="2">
                    </div>

                    <div class="control-group">
                        <label>ä¸¦ã³é †</label>
                        <select id="sort-order">
                            <option value="shuffled">ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰</option>
                            <option value="original">å…¥åŠ›é †ã‚’ç¶­æŒ</option>
                        </select>
                    </div>

                    <div class="control-group" style="border-top:1px solid #eee; padding-top:15px;">
                        <label>
                            åç°¿ãƒªã‚¹ãƒˆã®ä¿å­˜
                            <span id="storage-status">ä¿å­˜å…ˆ: ãƒ–ãƒ©ã‚¦ã‚¶</span>
                        </label>
                        <div class="cloud-actions">
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="text" id="save-name" placeholder="ãƒªã‚¹ãƒˆå (ä¾‹: åˆå®¿ç­)">
                                <button id="btn-cloud-save" class="c-btn bg-blue" style="width:60px;">ä¿å­˜</button>
                            </div>
                            <div style="font-size:11px; text-align:right; margin-bottom:5px;">
                                <span id="list-save-status"></span>
                            </div>
                            
                            <div style="display:flex; gap:5px; align-items:center;">
                                <select id="cloud-load-select" style="flex:1;"><option value="">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option></select>
                            </div>
                            <div class="cloud-btn-row">
                                <button id="btn-cloud-load" class="c-btn bg-green">èª­è¾¼</button>
                                <button id="btn-cloud-delete" class="c-btn bg-red">å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="execution-area">
            <button class="action-btn" onclick="divideGroups()">
                ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ
            </button>
            <br>
            <div id="history-save-indicator"></div>

            <button id="btn-csv-download" disabled onclick="downloadCSV()">
                CSVã§ä¿å­˜
            </button>
        </div>

        <div id="output-header">
            <span id="output-title"></span>
        </div>
        <div id="output"></div>

        <div class="section-box" style="margin-top: 20px;">
            <div class="section-header" onclick="toggleSection('history-content', 'history-icon')">
                <h2>éå»ã®å®Ÿè¡Œçµæœãƒ»å±¥æ­´ (æœ€å¤§10ä»¶)</h2>
                <span class="material-icons" id="history-icon">expand_less</span>
            </div>
            <div class="section-content" id="history-content" style="padding:0;">
                <ul id="history-list">
                    <li style="padding:20px; text-align:center; color:#888;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
            </div>
        </div>

        <div class="control-group" style="margin-top: 20px; display:none;">
            <label>CSVãƒ•ã‚¡ã‚¤ãƒ«å</label>
            <input type="text" id="csv-filename" autocomplete="off" placeholder="ç©ºæ¬„ãªã‚‰æ—¥æ™‚">
        </div>
    </main>

    <div id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

    <div id="modal-ui" class="modal-overlay hidden">
        <div class="mini-window">
            <div class="window-header"><span id="modal-title"></span><button id="modal-close" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button></div>
            <div class="window-body">
                <button class="google-btn" id="google-auth-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"> Googleã§ç¶šè¡Œ</button>
                <div style="margin: 15px 0; border-bottom: 1px solid #eee; line-height:0.1em; color:#999;">or</div>
                <input type="email" id="input-email" class="auth-input" autocomplete="username" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <input type="password" id="input-pass" class="auth-input" autocomplete="current-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button id="auth-execute-btn" class="primary-btn">é€ä¿¡</button>
                <p id="auth-toggle-text" style="color:#1a73e8; font-size:13px; cursor:pointer; margin-top:15px;"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtQGq5IJXyoHGBGpx25ZfVkXWL-iRRqC8",
            authDomain: "my-programming-tools-auth.firebaseapp.com",
            projectId: "my-programming-tools-auth",
            storageBucket: "my-programming-tools-auth.firebasestorage.app",
            messagingSenderId: "617449767952",
            appId: "1:617449767952:web:12f75dcb19f2035d637695"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- å¤‰æ•°å®šç¾© ---
        let currentUser = null;
        let lastRes = []; 
        let historySaveTimer = null; 
        let listAutoSaveTimer = null;

        const LS_KEY_HISTORY = 'group_tool_history_v1';
        const LS_KEY_LISTS = 'group_tool_lists_v4';

        // --- ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ ---
        function showToast(message) {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- ãƒ‰ãƒ­ãƒ¯ãƒ¼åˆ¶å¾¡ ---
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const drawer = document.getElementById('mobile-drawer');
        const overlay = document.getElementById('drawer-overlay');
        const drawerClose = document.getElementById('drawer-close');

        function openDrawer() { drawer.classList.add('open'); overlay.classList.add('open'); }
        function closeDrawer() { drawer.classList.remove('open'); overlay.classList.remove('open'); }

        hamburgerBtn.addEventListener('click', openDrawer);
        overlay.addEventListener('click', closeDrawer);
        drawerClose.addEventListener('click', closeDrawer);

        // --- UIåˆ¶å¾¡ ---
        window.toggleSection = (id, iconId) => {
            const el = document.getElementById(id);
            const icon = document.getElementById(iconId);
            el.classList.toggle('hidden');
            icon.textContent = el.classList.contains('hidden') ? 'expand_more' : 'expand_less';
        };

        const userBtn = document.getElementById('main-user-btn');
        const dropdown = document.getElementById('dropdown-ui');
        const guestNav = document.getElementById('header-guest-nav');
        const modal = document.getElementById('modal-ui');
        const storageStatus = document.getElementById('storage-status');
        let mode = 'login';

        userBtn.onclick = (e) => { e.stopPropagation(); dropdown.classList.toggle('hidden'); };
        document.onclick = () => dropdown.classList.add('hidden');
        document.getElementById('modal-close').onclick = () => modal.classList.add('hidden');

        function openAuth(m) {
            mode = m;
            modal.classList.remove('hidden');
            document.getElementById('modal-title').textContent = m === 'login' ? 'ã‚µã‚¤ãƒ³ã‚¤ãƒ³' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ';
            document.getElementById('auth-execute-btn').textContent = m === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'ç™»éŒ²ã™ã‚‹';
            document.getElementById('auth-toggle-text').textContent = m === 'login' ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ã“ã¡ã‚‰' : 'ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰';
        }

        document.getElementById('nav-signin').onclick = () => openAuth('login');
        document.getElementById('nav-signup').onclick = () => openAuth('signup');
        document.getElementById('auth-toggle-text').onclick = () => openAuth(mode === 'login' ? 'signup' : 'login');
        document.getElementById('trigger-logout').onclick = () => signOut(auth);

        document.getElementById('google-auth-btn').onclick = async (e) => {
            e.stopPropagation();
            try { await signInWithPopup(auth, new GoogleAuthProvider()); modal.classList.add('hidden'); } catch (err) { alert("å¤±æ•—: " + err.message); }
        };
        document.getElementById('auth-execute-btn').onclick = async () => {
            const e = document.getElementById('input-email').value;
            const p = document.getElementById('input-pass').value;
            try {
                if(mode === 'login') await signInWithEmailAndPassword(auth, e, p);
                else await createUserWithEmailAndPassword(auth, e, p);
                modal.classList.add('hidden');
            } catch (err) { alert(err.message); }
        };
        document.getElementById('trigger-delete-account').onclick = async () => {
            if (!currentUser || !confirm("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try { await currentUser.delete(); location.reload(); } catch (err) { alert("å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); signOut(auth); }
        };

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                guestNav.classList.add('hidden');
                userBtn.classList.remove('hidden');
                document.getElementById('display-email').textContent = user.email;
                storageStatus.textContent = "ä¿å­˜å…ˆ: ã‚¯ãƒ©ã‚¦ãƒ‰(ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)";
                storageStatus.className = "status-cloud";
                refreshSavedLists();
                loadHistory();       
            } else {
                guestNav.classList.remove('hidden');
                userBtn.classList.add('hidden');
                storageStatus.textContent = "ä¿å­˜å…ˆ: ãƒ–ãƒ©ã‚¦ã‚¶(ãƒ­ãƒ¼ã‚«ãƒ«)";
                storageStatus.className = "status-local";
                refreshSavedLists();
                loadHistory();       
            }
        });

        // --- åç°¿ä¿å­˜æ©Ÿèƒ½ ---
        async function saveNameList(isAuto = false) {
            const name = document.getElementById('save-name').value.trim();
            const content = document.getElementById('names-input').value;
            const statusEl = document.getElementById('list-save-status');
            
            if (isAuto && !name) {
                statusEl.textContent = "";
                return;
            }
            if (!name) return alert("ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            if (isAuto) {
                statusEl.textContent = "ä¿å­˜ä¸­...";
                statusEl.classList.add('status-saving');
            }

            const saveData = { content: content };

            try {
                if (currentUser) {
                    await setDoc(doc(db, "users", currentUser.uid), { savedLists: { [name]: saveData } }, { merge: true });
                } else {
                    const lists = JSON.parse(localStorage.getItem(LS_KEY_LISTS) || '{}');
                    lists[name] = saveData;
                    localStorage.setItem(LS_KEY_LISTS, JSON.stringify(lists));
                }

                if (isAuto) {
                    statusEl.textContent = "ä¿å­˜å®Œäº†";
                    statusEl.classList.remove('status-saving');
                    setTimeout(() => { if(statusEl.textContent === "ä¿å­˜å®Œäº†") statusEl.textContent = ""; }, 2000);
                } else {
                    showToast(`ä¿å­˜ã—ã¾ã—ãŸ: ${name}`);
                }
                refreshSavedLists();

            } catch(e) {
                console.error("Save Error:", e);
                if(isAuto) statusEl.textContent = "ä¿å­˜å¤±æ•—";
                else alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        document.getElementById('btn-cloud-save').onclick = () => saveNameList(false);

        document.getElementById('names-input').addEventListener('input', () => {
            const name = document.getElementById('save-name').value.trim();
            const statusEl = document.getElementById('list-save-status');
            
            if (!name) return;

            statusEl.textContent = "ç·¨é›†ä¸­...";
            statusEl.classList.remove('status-saving');

            if (listAutoSaveTimer) clearTimeout(listAutoSaveTimer);
            listAutoSaveTimer = setTimeout(() => {
                saveNameList(true);
            }, 3000);
        });

        async function refreshSavedLists() {
            const sel = document.getElementById('cloud-load-select');
            const currentVal = sel.value;
            
            sel.innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ...</option>';
            let lists = {};
            if (currentUser) {
                try {
                    const snap = await getDoc(doc(db, "users", currentUser.uid));
                    if (snap.exists() && snap.data().savedLists) lists = snap.data().savedLists;
                } catch(e) { console.error(e); }
            } else {
                lists = JSON.parse(localStorage.getItem(LS_KEY_LISTS) || '{}');
            }
            Object.keys(lists).sort().forEach(k => {
                const o = document.createElement('option'); o.value = k; o.textContent = k; 
                sel.appendChild(o);
            });
            if(currentVal && lists[currentVal]) sel.value = currentVal;
        }

        document.getElementById('btn-cloud-load').onclick = async () => {
            const name = document.getElementById('cloud-load-select').value;
            if(!name) return;
            let loadedData = null;
            if (currentUser) {
                const snap = await getDoc(doc(db, "users", currentUser.uid));
                if(snap.exists()) loadedData = snap.data().savedLists[name];
            } else {
                const lists = JSON.parse(localStorage.getItem(LS_KEY_LISTS) || '{}');
                loadedData = lists[name];
            }
            if(loadedData) {
                const text = (typeof loadedData === 'string') ? loadedData : (loadedData.content || "");
                document.getElementById('names-input').value = text;
                document.getElementById('save-name').value = name;
                document.getElementById('list-save-status').textContent = "";
            }
        };

        document.getElementById('btn-cloud-delete').onclick = async () => {
            const name = document.getElementById('cloud-load-select').value;
            if (!name || !confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            if (currentUser) {
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { [`savedLists.${name}`]: deleteField() });
                    refreshSavedLists();
                    showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
                } catch(e) { alert("å‰Šé™¤å¤±æ•—"); }
            } else {
                const lists = JSON.parse(localStorage.getItem(LS_KEY_LISTS) || '{}');
                delete lists[name];
                localStorage.setItem(LS_KEY_LISTS, JSON.stringify(lists));
                refreshSavedLists();
                showToast("å‰Šé™¤ã—ã¾ã—ãŸ");
            }
            if (document.getElementById('save-name').value === name) {
                document.getElementById('save-name').value = "";
            }
        };

        // --- ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ ---
        window.divideGroups = async () => {
            const rawText = document.getElementById('names-input').value;
            const count = parseInt(document.getElementById('group-count').value);
            const sort = document.getElementById('sort-order').value;

            if (rawText.trim() === "") return alert("åç°¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            if (isNaN(count) || count < 1) return alert("ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯1ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚");

            const sectionsRaw = rawText.split(/\n\s*\n/);
            const sections = [];
            let totalPeople = 0;

            sectionsRaw.forEach(secStr => {
                const lines = secStr.split(/\n/).map(s => s.trim()).filter(s => s !== "");
                if (lines.length > 0) {
                    sections.push(lines);
                    totalPeople += lines.length;
                }
            });

            if (totalPeople === 0) return alert("åç°¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            if (count > totalPeople) return alert(`äººæ•°(${totalPeople}äºº)ã‚ˆã‚Šå¤šã„ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯ä½œã‚Œã¾ã›ã‚“ã€‚`);

            const groups = Array.from({length: count}, () => []);
            let currentOffset = 0;

            sections.forEach(lines => {
                const shuf = [...lines].sort(() => Math.random() - 0.5);
                shuf.forEach((n, i) => {
                    groups[(i + currentOffset) % count].push(n);
                });
                currentOffset = (currentOffset + lines.length) % count;
            });

            lastRes = groups.map(g => {
                if (sort === 'original') return g.sort((a,b) => rawText.indexOf(a) - rawText.indexOf(b));
                return g;
            });

            // è¡¨ç¤ºï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥åŠ¹æœã‚ã‚Šï¼‰
            displayResult(lastRes, "å®Ÿè¡Œçµæœ");

            // --- å±¥æ­´ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ3ç§’å¾…æ©Ÿï¼‰ ---
            const ind = document.getElementById('history-save-indicator');
            if (historySaveTimer) clearTimeout(historySaveTimer);

            ind.innerHTML = '<span class="text-wait">â³ 3ç§’å¾Œã«å±¥æ­´ã¸ä¿å­˜ã—ã¾ã™...</span>';
            
            historySaveTimer = setTimeout(async () => {
                ind.innerHTML = '<span class="text-saving">å±¥æ­´ã«ä¿å­˜ä¸­...</span>';
                
                await saveToHistory(lastRes)
                    .then(() => {
                        ind.innerHTML = '<span class="text-done">âœ… å±¥æ­´ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>';
                    })
                    .catch((err) => {
                        console.error("å±¥æ­´ä¿å­˜å¤±æ•—:", err);
                        ind.innerHTML = `<span class="text-error">âš  ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${err.message}</span>`;
                    });
                historySaveTimer = null;
            }, 3000);
        };

        function displayResult(resultData, titleLabel = "") {
            lastRes = resultData;
            const outputArea = document.getElementById('output');
            const header = document.getElementById('output-header');
            const titleEl = document.getElementById('output-title');

            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            if(titleLabel) {
                header.style.display = "flex";
                titleEl.textContent = titleLabel;
            } else {
                header.style.display = "none";
            }

            // ãƒ‡ãƒ¼ã‚¿æç”»
            outputArea.innerHTML = resultData.map((g, i) => 
                `<div class="group-box">
                    <span class="group-title">ã‚°ãƒ«ãƒ¼ãƒ— ${i+1} (${g.length}å)</span>
                    ${g.join('ã€ ')}
                 </div>`
            ).join('');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç« (classã‚’ä¸€åº¦å¤–ã—ã¦ä»˜ã‘ç›´ã™)
            outputArea.classList.remove('updated-flash');
            void outputArea.offsetWidth; // Reflow trigger
            outputArea.classList.add('updated-flash');

            const csvBtn = document.getElementById('btn-csv-download');
            csvBtn.disabled = false;
            
            // å°‘ã—ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
            header.scrollIntoView({behavior: "smooth", block: "start"});
        }

        // --- å±¥æ­´æ©Ÿèƒ½ ---
        function createHistoryItem(result) {
            if (!result || !Array.isArray(result)) return null;

            // Firestoreåˆ¶é™å›é¿: 2æ¬¡å…ƒé…åˆ—ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«
            const safeData = result.map(group => ({ members: group }));

            return {
                id: Date.now(),
                date: new Date().toLocaleString('ja-JP'),
                data: safeData,
                count: result.length,
                total: result.flat().length
            };
        }

        async function saveToHistory(result) {
            const item = createHistoryItem(result);
            if (!item) throw new Error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™");

            if (currentUser) {
                const userRef = doc(db, "users", currentUser.uid);
                const snap = await getDoc(userRef);
                let hist = snap.exists() && snap.data().history ? snap.data().history : [];
                
                hist.unshift(item); 
                if (hist.length > 10) hist = hist.slice(0, 10);
                
                await setDoc(userRef, { history: hist }, { merge: true });
                renderHistoryList(hist);
            } else {
                let hist = [];
                try {
                    const stored = localStorage.getItem(LS_KEY_HISTORY);
                    if (stored) hist = JSON.parse(stored);
                } catch(e) { console.warn("Reset", e); hist = []; }
                
                if (!Array.isArray(hist)) hist = [];
                hist.unshift(item);
                if (hist.length > 10) hist = hist.slice(0, 10);
                
                localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(hist));
                renderHistoryList(hist);
            }
        }

        async function loadHistory() {
            let hist = [];
            
            if (currentUser) {
                try {
                    const snap = await getDoc(doc(db, "users", currentUser.uid));
                    if (snap.exists() && snap.data().history) hist = snap.data().history;
                } catch(e) { console.error(e); }
            } else {
                try {
                    const stored = localStorage.getItem(LS_KEY_HISTORY);
                    if (stored) hist = JSON.parse(stored);
                } catch(e) { console.error(e); }
            }
            renderHistoryList(hist);
        }

        function renderHistoryList(histArray) {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            
            if (!histArray || !Array.isArray(histArray) || histArray.length === 0) {
                listEl.innerHTML = '<li style="padding:20px; text-align:center; color:#888;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                return;
            }
            
            histArray.forEach((item) => {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã«æœ€åˆã®æ•°åã‚’å–å¾—
                let firstGroupMembers = [];
                if(item.data && item.data.length > 0) {
                     // æ–°å½¢å¼ or æ—§å½¢å¼
                     const g1 = item.data[0];
                     if(g1.members) firstGroupMembers = g1.members; // æ–°å½¢å¼
                     else if(Array.isArray(g1)) firstGroupMembers = g1; // æ—§å½¢å¼
                }
                const previewText = firstGroupMembers.slice(0, 3).join("ã€") + (firstGroupMembers.length > 3 ? "..." : "");

                const li = document.createElement('li');
                li.className = 'history-item';
                // ã€Œä¾‹ï¼šã€ã‚’å‰Šé™¤ã—ã¦ãƒ¡ãƒ³ãƒãƒ¼åã ã‘è¡¨ç¤º
                li.innerHTML = `
                    <div class="history-left">
                        <div class="history-date">${item.date}</div>
                        <div class="history-info">${item.count}ã‚°ãƒ«ãƒ¼ãƒ— / è¨ˆ${item.total}å</div>
                        <div class="history-preview">ï¼ˆ${previewText || 'ä¸æ˜'}ï¼‰</div>
                    </div>
                    <div class="history-actions">
                        <button class="btn-restore">è¡¨ç¤º</button>
                        <button class="btn-history-delete" title="å‰Šé™¤"><span class="material-icons">delete</span></button>
                    </div>
                `;
                
                // è¡¨ç¤ºãƒœã‚¿ãƒ³
                li.querySelector('.btn-restore').onclick = () => {
                    let restoreData = item.data;
                    if (restoreData.length > 0 && !Array.isArray(restoreData[0]) && restoreData[0].members) {
                        restoreData = restoreData.map(g => g.members);
                    }
                    displayResult(restoreData, `ğŸ“œ å±¥æ­´: ${item.date}`);
                    showToast("å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
                };

                // å‰Šé™¤ãƒœã‚¿ãƒ³
                li.querySelector('.btn-history-delete').onclick = () => deleteHistoryItem(item.id);

                listEl.appendChild(li);
            });
        }

        async function deleteHistoryItem(targetId) {
            if(!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

            if (currentUser) {
                // Cloud Deletion
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    const snap = await getDoc(userRef);
                    if (snap.exists() && snap.data().history) {
                        const newHist = snap.data().history.filter(h => h.id !== targetId);
                        await updateDoc(userRef, { history: newHist });
                        showToast("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                        renderHistoryList(newHist);
                    }
                } catch(e) {
                    alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
                }
            } else {
                // Local Deletion
                try {
                    const stored = localStorage.getItem(LS_KEY_HISTORY);
                    if (stored) {
                        const hist = JSON.parse(stored);
                        const newHist = hist.filter(h => h.id !== targetId);
                        localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(newHist));
                        showToast("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                        renderHistoryList(newHist);
                    }
                } catch(e) {
                    console.error(e);
                }
            }
        }

        // --- CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
        window.downloadCSV = () => {
            if(lastRes.length === 0) return;
            let csv = "\uFEFF";
            csv += lastRes.map((_, i) => `"ã‚°ãƒ«ãƒ¼ãƒ— ${i+1}"`).join(",") + "\n";
            const maxRows = Math.max(...lastRes.map(g => g.length));
            for (let i = 0; i < maxRows; i++) {
                csv += lastRes.map(g => g[i] ? `"${g[i]}"` : "").join(",") + "\n";
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement("a");
            let filename = document.getElementById('csv-filename').value.trim();
            if(!filename) {
                const d = new Date();
                filename = `grouping_${d.getFullYear()}${d.getMonth()+1}${d.getDate()}_${d.getHours()}${d.getMinutes()}`;
            }
            if(!filename.endsWith(".csv")) filename += ".csv";
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        };

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        loadHistory();
    </script>
</body>
</html>